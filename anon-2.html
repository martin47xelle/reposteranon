<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar v52 - Gallery Only</title>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --gold: #f0b90b; --green: #2ebd85; --blue: #3498db; --red: #f6465d; }
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e9eaeb; 
            margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; overflow-y: auto; 
        }
        .main-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 12px; }
        .box { background: var(--card); border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .header { background: #2b3139; padding: 12px 15px; font-weight: bold; color: var(--gold); border-bottom: 1px solid #444; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ANA GALERƒ∞: T√ºm ekranƒ± kaplayan ƒ±zgara */
        #gallery-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
            padding: 12px; 
            background: #000; 
            min-height: 300px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .gal-item-wrapper { position: relative; }
        .gal-item { 
            width: 100%; aspect-ratio: 1; object-fit: cover; 
            border-radius: 8px; border: 2px solid #222; cursor: pointer; transition: 0.2s; 
        }
        .gal-item:hover { border-color: var(--gold); transform: scale(1.02); }
        .user-tag { 
            position: absolute; bottom: 5px; left: 5px; right: 5px; 
            background: rgba(0,0,0,0.7); font-size: 9px; color: #fff; 
            padding: 2px 4px; border-radius: 3px; text-align: center; overflow: hidden; 
        }

        #sys-log { height: 100px; overflow-y: auto; padding: 10px; font-size: 11px; color: #848e9c; background: #161a1e; border-top: 1px solid #333; }
        
        .input-panel { padding: 15px; background: var(--card); border-top: 1px solid #333; }
        input { width: 100%; background: #121212; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; font-size: 14px; }
        
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: #000; width: 100%; margin-bottom: 8px; }
        .btn-red { background: var(--red); color: white; width: 100%; }
        .btn-clear { background: var(--red); color: white; padding: 5px 10px; font-size: 10px; }
        
        .status-badge { display: flex; align-items: center; gap: 6px; font-size: 11px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--red); }
        .active-loop { animation: pulse 1.5s infinite; background: var(--green) !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="box">
        <div class="header">
            <span>üñºÔ∏è CANLI RESƒ∞M RADARI</span>
            <button class="btn-clear" onclick="clearAll()">GALERƒ∞Yƒ∞ Sƒ∞L</button>
        </div>
        <div id="gallery-grid"></div>
        <div id="sys-log"></div>
    </div>

    <div class="box">
        <div class="header">
            <span>‚öôÔ∏è AYARLAR</span>
            <div class="status-badge"><div id="dot" class="dot"></div> <span id="ping-text">BAƒûLI DEƒûƒ∞L</span></div>
        </div>
        <div class="input-panel">
            <input type="text" id="token" placeholder="JWT Token Yapƒ±≈ütƒ±rƒ±n...">
            <button class="btn-gold" id="startBtn" onclick="toggleSafety(true)">üõ°Ô∏è KORUMAYI BA≈ûLAT (20sn)</button>
            <button class="btn-red" onclick="toggleSafety(false)">üõë DURDUR</button>
        </div>
    </div>
</div>

<script>
let ws;
let safetyTimer = null;
let contentFingerprints = new Set(); // ƒ∞√ßerik tabanlƒ± engelleme

function sysLog(m, c="#848e9c") {
    const l = document.getElementById('sys-log');
    l.innerHTML += `<div style="color:${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
    l.scrollTop = l.scrollHeight;
}

function toggleSafety(start) {
    if(start) {
        if(safetyTimer) return;
        sysLog("üõ°Ô∏è Koruma ve Otomatik Yenileme Aktif!", "var(--gold)");
        connect();
        safetyTimer = setInterval(connect, 20000);
        document.getElementById('startBtn').classList.add('active-loop');
        document.getElementById('startBtn').innerText = "üõ°Ô∏è KORUMA √áALI≈ûIYOR...";
    } else {
        clearInterval(safetyTimer);
        safetyTimer = null;
        if(ws) ws.close();
        document.getElementById('startBtn').classList.remove('active-loop');
        document.getElementById('startBtn').innerText = "üõ°Ô∏è KORUMAYI BA≈ûLAT (20sn)";
        document.getElementById('dot').style.background = "var(--red)";
        document.getElementById('ping-text').innerText = "DURDURULDU";
        sysLog("üõë Sistem durduruldu.", "var(--red)");
    }
}

function connect() {
    const t = document.getElementById('token').value.trim();
    if(!t) return;
    localStorage.setItem('last_token', t);
    
    if(ws) { ws.onclose = null; ws.close(); }
    ws = new WebSocket(`wss://chat.anonim.chat/socket.io/?token=${t}&EIO=3&transport=websocket`);
    
    ws.onopen = () => {
        document.getElementById('dot').style.background = "var(--green)";
        document.getElementById('ping-text').innerText = "CANLI";
        // Sunucuya "ben buradayƒ±m" sinyali
        setInterval(() => { if(ws.readyState===1) ws.send('2'); }, 10000);
    };

    ws.onmessage = (e) => {
        if(e.data.startsWith('42')) {
            try {
                const j = JSON.parse(e.data.substring(e.data.indexOf('[')));
                const p = j[1];
                const d = p.d || p;
                
                // Gelen veride resim var mƒ±?
                const img = d.media?.media_url || d.message?.media?.media_url;
                const user = d.username || (d.message && d.message.username);
                const msgId = d.msg_id || d.message?.msg_id || d.id;

                if(img && user) {
                    // PARMAK ƒ∞Zƒ∞ KONTROL√ú (URL √ºzerinden)
                    if(contentFingerprints.has(img)) return; 
                    contentFingerprints.add(img);

                    addGal(img, user, msgId);
                    sysLog(`üì∏ Yeni resim yakalandƒ±: @${user}`, "var(--gold)");
                }
            } catch(err) {}
        }
    };

    ws.onclose = () => {
        if(!safetyTimer) {
            document.getElementById('dot').style.background = "var(--red)";
            document.getElementById('ping-text').innerText = "KOPUK";
        }
    };
}

function addGal(src, user, id) {
    const grid = document.getElementById('gallery-grid');
    const wrapper = document.createElement('div');
    wrapper.className = 'gal-item-wrapper';
    
    wrapper.innerHTML = `
        <img src="${src}" class="gal-item" onclick="sendSeen('${user}','${id}')">
        <div class="user-tag">@${user}</div>
    `;
    
    grid.prepend(wrapper);
}

function sendSeen(u, i) {
    if(!ws || ws.readyState !== 1 || !i) return;
    ws.send(`420${JSON.stringify(["messageDataToUser", {"username": u, "type": "oneTimeMediaSeen", "msg_id": i}, null])}`);
    sysLog(`‚úîÔ∏è @${u} ki≈üisine onay iletildi.`, "var(--green)");
}

function clearAll() {
    document.getElementById('gallery-grid').innerHTML = '';
    document.getElementById('sys-log').innerHTML = '';
    contentFingerprints.clear();
    sysLog("üßπ T√ºm veriler temizlendi.");
}

// Token hatƒ±rlatƒ±cƒ±
document.getElementById('token').value = localStorage.getItem('last_token') || "";
</script>
</body>
</html>