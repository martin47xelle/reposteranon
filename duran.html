<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar v56 - Time Stamps</title>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --gold: #f0b90b; --green: #2ebd85; --blue: #3498db; --red: #f6465d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e9eaeb; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .main-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; }
        .box { background: var(--card); border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .header { background: #2b3139; padding: 12px; font-weight: bold; color: var(--gold); border-bottom: 1px solid #444; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        
        #gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; padding: 10px; background: #000; min-height: 250px; max-height: 65vh; overflow-y: auto; }
        .gal-item-wrapper { position: relative; border-radius: 8px; overflow: hidden; border: 1px solid #222; background: #111; }
        .gal-item { width: 100%; aspect-ratio: 1; object-fit: cover; cursor: pointer; display: block; }
        
        /* ZAMAN VE KULLANICI ETƒ∞KETƒ∞ */
        .info-tag { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.75); font-size: 8px; text-align: center; color: #fff; padding: 2px 0; line-height: 1.2; }
        .time-ago { color: var(--gold); font-weight: bold; display: block; }

        #sys-log { height: 80px; overflow-y: auto; padding: 10px; font-size: 10px; color: #848e9c; background: #161a1e; border-top: 1px solid #333; }
        .input-panel { padding: 15px; background: var(--card); border-top: 1px solid #333; }
        input { width: 100%; background: #121212; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; margin-bottom: 8px; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-bottom: 5px; width: 100%; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-red { background: var(--red); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .active-loop { animation: pulse 1.5s infinite; background: var(--green) !important; color: white !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="box">
        <div class="header">
            <span>üñºÔ∏è ZAMANLI RADAR v56</span>
            <button onclick="clearGallery()" style="width:auto; padding:4px 10px; background:var(--red); font-size:10px; color:white; border-radius:4px; border:none; cursor:pointer;">TEMƒ∞ZLE</button>
        </div>
        <div id="gallery-grid"></div>
        <div id="sys-log"></div>
    </div>


    eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9<br>.eyJ1c2VyX2lkIjo4OTM2Njc0MjU1MTE3ODksImFub24iOiIyYTU<br>xMWM1YzM3NjhjY2IiLCJoYXNoIjoiNjRlMTliMDI5NGRiOTgyNGM5O<br>GQ0OGJlYTMwZjFlZDUiLCJ0aW1lIjoxNz<br>Y5ODE0MTQxfQ.Kxp1<br>ojSboqfe0ZZAgoiHpMySQGSug5s2Rdb<br>t1Jlf9TE

    <div class="box">
        <div class="header"><span>‚öôÔ∏è KONTROL</span><span id="status-text" style="font-size:10px; color:var(--red);">‚óè DURDURULDU</span></div>
        <div class="input-panel">
            <input type="text" id="token" value="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjo4OTM2Njc0MjU1MTE3ODksImFub24iOiIyYTUxMWM1YzM3NjhjY2IiLCJoYXNoIjoiNjRlMTliMDI5NGRiOTgyNGM5OGQ0OGJlYTMwZjFlZDUiLCJ0aW1lIjoxNzY5ODE0MTQxfQ.Kxp1ojSboqfe0ZZAgoiHpMySQGSug5s2Rdbt1Jlf9TE">
            <button class="btn-gold" id="startBtn" onclick="toggleSafety(true)">üõ°Ô∏è KORUMAYI BA≈ûLAT</button>
            <button class="btn-red" onclick="toggleSafety(false)">üõë Sƒ∞STEMƒ∞ DURDUR</button>
            <button class="btn-blue" onclick="generateShareLink()">üîó SENKRONƒ∞ZE Lƒ∞NKƒ∞ KOPYALA</button>
        </div>
    </div>
</div>

<script>
let ws;
let safetyTimer = null;
let fingerprints = new Set();

// Sayfa y√ºklendiƒüinde
window.onload = () => {
    loadGalleryFromStorage();
    
    // S√ºreleri her 30 saniyede bir g√ºncelle
    setInterval(updateAllTimes, 30000);

    const params = new URLSearchParams(window.location.search);
    const urlToken = params.get('token');
    const urlStart = params.get('start');

    if (urlToken) {
        document.getElementById('token').value = urlToken;
        if (urlStart === 'true' && localStorage.getItem('radar_active') !== 'false') toggleSafety(true);
    } else {
        document.getElementById('token').value = localStorage.getItem('last_token') || "";
        if (localStorage.getItem('radar_active') === 'true') toggleSafety(true);
    }
};

function sysLog(m, c="#848e9c") {
    const l = document.getElementById('sys-log');
    l.innerHTML += `<div style="color:${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
    l.scrollTop = l.scrollHeight;
}

// ZAMAN HESAPLAMA FONKSƒ∞YONU
function timeAgo(timestamp) {
    const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
    if (seconds < 60) return `${seconds}sn √∂nce`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}dk √∂nce`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}sa √∂nce`;
    return new Date(timestamp).toLocaleDateString();
}

// T√úM ETƒ∞KETLERƒ∞ G√úNCELLE
function updateAllTimes() {
    document.querySelectorAll('.time-ago').forEach(el => {
        const ts = el.getAttribute('data-ts');
        el.innerText = timeAgo(parseInt(ts));
    });
}

function loadGalleryFromStorage() {
    const saved = JSON.parse(localStorage.getItem('radar_gallery_v56') || "[]");
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = '';
    saved.forEach(item => {
        fingerprints.add(item.img);
        renderImage(item.img, item.user, item.mid, item.timestamp);
    });
}

function saveImageToStorage(img, user, mid, timestamp) {
    let saved = JSON.parse(localStorage.getItem('radar_gallery_v56') || "[]");
    if (!saved.some(i => i.img === img)) {
        saved.push({ img, user, mid, timestamp });
        if (saved.length > 200) saved.shift();
        localStorage.setItem('radar_gallery_v56', JSON.stringify(saved));
    }
}

function renderImage(src, user, id, timestamp) {
    const grid = document.getElementById('gallery-grid');
    const div = document.createElement('div');
    div.className = 'gal-item-wrapper';
    div.innerHTML = `
        <img src="${src}" class="gal-item" onclick="sendSeen('${user}','${id}')" onerror="this.src='https://placehold.co/100x100?text=Hata'">
        <div class="info-tag">
            <span class="time-ago" data-ts="${timestamp}">${timeAgo(timestamp)}</span>
            @${user}
        </div>
    `;
    grid.prepend(div);
}

function toggleSafety(start) {
    if(start) {
        if(safetyTimer) return;
        localStorage.setItem('radar_active', 'true');
        connect();
        safetyTimer = setInterval(connect, 20000);
        document.getElementById('startBtn').classList.add('active-loop');
        document.getElementById('status-text').innerText = "‚óè AKTƒ∞F";
        document.getElementById('status-text').style.color = "var(--green)";
        sysLog("üõ°Ô∏è Sistem Aktif.", "var(--gold)");
    } else {
        localStorage.setItem('radar_active', 'false');
        clearInterval(safetyTimer);
        safetyTimer = null;
        if(ws) { ws.onclose = null; ws.close(); }
        document.getElementById('startBtn').classList.remove('active-loop');
        document.getElementById('status-text').innerText = "‚óè DURDURULDU";
        document.getElementById('status-text').style.color = "var(--red)";
        sysLog("üõë Durduruldu.", "var(--red)");
    }
}

function connect() {
    const t = document.getElementById('token').value.trim();
    if(!t || localStorage.getItem('radar_active') === 'false') return;
    localStorage.setItem('last_token', t);
    if(ws) { ws.onclose = null; ws.close(); }
    ws = new WebSocket(`wss://chat.anonim.chat/socket.io/?token=${t}&EIO=3&transport=websocket`);
    ws.onopen = () => { setInterval(() => { if(ws.readyState===1) ws.send('2'); }, 10000); };
    ws.onmessage = (e) => {
        if(e.data.startsWith('42')) {
            try {
                const j = JSON.parse(e.data.substring(e.data.indexOf('[')));
                const p = j[1];
                const d = p.d || p;
                const img = d.media?.media_url || d.message?.media?.media_url;
                const user = d.username || (d.message && d.message.username);
                const mid = d.msg_id || d.message?.msg_id || d.id;

                if(img && !fingerprints.has(img)) {
                    const now = Date.now();
                    fingerprints.add(img);
                    renderImage(img, user, mid, now);
                    saveImageToStorage(img, user, mid, now);
                    sysLog(`üì∏ Yakalandƒ±: @${user}`, "var(--gold)");
                }
            } catch(err) {}
        }
    };
}

function sendSeen(u, i) {
    if(!ws || ws.readyState !== 1) return alert("Dinleme a√ßƒ±k olmalƒ±!");
    ws.send(`420${JSON.stringify(["messageDataToUser", {"username": u, "type": "oneTimeMediaSeen", "msg_id": i}, null])}`);
    sysLog(`‚úîÔ∏è Onay: @${u}`, "var(--green)");
}

function generateShareLink() {
    const t = document.getElementById('token').value.trim();
    const shareUrl = `${window.location.href.split('?')[0]}?token=${t}&start=true`;
    navigator.clipboard.writeText(shareUrl);
    sysLog("üîó Link Kopyalandƒ±.");
}

function clearGallery() {
    if(confirm("T√ºm ar≈üiv silinecek?")) {
        localStorage.removeItem('radar_gallery_v56');
        fingerprints.clear();
        document.getElementById('gallery-grid').innerHTML = '';
        sysLog("üßπ Temizlendi.");
    }
}
</script>
</body>
</html>



