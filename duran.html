<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar v55 - Persistent Archive</title>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --gold: #f0b90b; --green: #2ebd85; --blue: #3498db; --red: #f6465d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #e9eaeb; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .main-wrapper { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 10px; }
        .box { background: var(--card); border-radius: 12px; border: 1px solid #333; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .header { background: #2b3139; padding: 12px; font-weight: bold; color: var(--gold); border-bottom: 1px solid #444; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        
        /* GALERƒ∞ ALANI */
        #gallery-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 6px; padding: 10px; 
            background: #000; 
            min-height: 250px; 
            max-height: 65vh; 
            overflow-y: auto; 
        }
        .gal-item-wrapper { position: relative; border-radius: 8px; overflow: hidden; border: 1px solid #222; background: #111; }
        .gal-item { width: 100%; aspect-ratio: 1; object-fit: cover; cursor: pointer; display: block; }
        .user-tag { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); font-size: 9px; text-align: center; color: #fff; padding: 3px 0; font-weight: bold; }
        
        #sys-log { height: 80px; overflow-y: auto; padding: 10px; font-size: 10px; color: #848e9c; background: #161a1e; border-top: 1px solid #333; }
        .input-panel { padding: 15px; background: var(--card); border-top: 1px solid #333; }
        input { width: 100%; background: #121212; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; margin-bottom: 5px; width: 100%; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-red { background: var(--red); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .active-loop { animation: pulse 1.5s infinite; background: var(--green) !important; color: white !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="box">
        <div class="header">
            <span>üñºÔ∏è RADAR AR≈ûƒ∞V v55</span>
            <button onclick="clearGallery()" style="width:auto; padding:4px 10px; background:var(--red); font-size:10px; color:white; border-radius:4px; border:none; cursor:pointer;">TEMƒ∞ZLE</button>
        </div>
        <div id="gallery-grid"></div>
        <div id="sys-log"></div>
    </div>

    <div class="box">
        <div class="header"><span>‚öôÔ∏è KONTROL</span><span id="status-text" style="font-size:10px; color:var(--red);">‚óè DURDURULDU</span></div>
        <div class="input-panel">
            <input type="text" id="token" placeholder="JWT Token...">
            <button class="btn-gold" id="startBtn" onclick="toggleSafety(true)">üõ°Ô∏è KORUMAYI BA≈ûLAT</button>
            <button class="btn-red" onclick="toggleSafety(false)">üõë Sƒ∞STEMƒ∞ DURDUR</button>
            <button class="btn-blue" onclick="generateShareLink()">üîó SENKRONƒ∞ZE Lƒ∞NKƒ∞ KOPYALA</button>
        </div>
    </div>
</div>

<script>
let ws;
let safetyTimer = null;
let fingerprints = new Set(); // Tekrar engelleme

// SAYFA Y√úKLENDƒ∞ƒûƒ∞NDE √áALI≈ûAN FONKSƒ∞YON
window.onload = () => {
    // 1. √ñnce Hafƒ±zadaki Resimleri Y√ºkle
    loadGalleryFromStorage();

    // 2. Token ve Otomatik Ba≈ülatma Kontrol√º
    const params = new URLSearchParams(window.location.search);
    const urlToken = params.get('token');
    const urlStart = params.get('start');

    if (urlToken) {
        document.getElementById('token').value = urlToken;
        if (urlStart === 'true' && localStorage.getItem('radar_active') !== 'false') toggleSafety(true);
    } else {
        document.getElementById('token').value = localStorage.getItem('last_token') || "";
        if (localStorage.getItem('radar_active') === 'true') toggleSafety(true);
    }
};

function sysLog(m, c="#848e9c") {
    const l = document.getElementById('sys-log');
    l.innerHTML += `<div style="color:${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
    l.scrollTop = l.scrollHeight;
}

// RESƒ∞MLERƒ∞ HAFIZADAN Y√úKLE
function loadGalleryFromStorage() {
    const saved = JSON.parse(localStorage.getItem('radar_gallery_v55') || "[]");
    const grid = document.getElementById('gallery-grid');
    grid.innerHTML = '';
    
    saved.forEach(item => {
        fingerprints.add(item.img);
        renderImage(item.img, item.user, item.mid);
    });
    
    if(saved.length > 0) sysLog(`üìÇ Ar≈üivden ${saved.length} resim y√ºklendi.`, "var(--blue)");
}

// RESMƒ∞ KALICI HAFIZAYA KAYDET
function saveImageToStorage(img, user, mid) {
    let saved = JSON.parse(localStorage.getItem('radar_gallery_v55') || "[]");
    // Zaten kayƒ±tlƒ± mƒ± kontrol√º
    if (!saved.some(i => i.img === img)) {
        saved.push({ img, user, mid });
        // Tarayƒ±cƒ±yƒ± ≈üi≈üirmemek i√ßin son 200 resmi tutar
        if (saved.length > 200) saved.shift(); 
        localStorage.setItem('radar_gallery_v55', JSON.stringify(saved));
    }
}

function toggleSafety(start) {
    if(start) {
        if(safetyTimer) return;
        localStorage.setItem('radar_active', 'true');
        connect();
        safetyTimer = setInterval(connect, 20000);
        
        document.getElementById('startBtn').classList.add('active-loop');
        document.getElementById('startBtn').innerText = "üõ°Ô∏è KORUMA DEVREDE";
        document.getElementById('status-text').innerText = "‚óè AKTƒ∞F";
        document.getElementById('status-text').style.color = "var(--green)";
        sysLog("üõ°Ô∏è Dinleme Ba≈ülatƒ±ldƒ±.", "var(--gold)");
    } else {
        localStorage.setItem('radar_active', 'false');
        clearInterval(safetyTimer);
        safetyTimer = null;
        if(ws) { ws.onclose = null; ws.close(); }
        
        document.getElementById('startBtn').classList.remove('active-loop');
        document.getElementById('startBtn').innerText = "üõ°Ô∏è KORUMAYI BA≈ûLAT";
        document.getElementById('status-text').innerText = "‚óè DURDURULDU";
        document.getElementById('status-text').style.color = "var(--red)";
        sysLog("üõë Durduruldu.", "var(--red)");
    }
}

function connect() {
    const t = document.getElementById('token').value.trim();
    if(!t || localStorage.getItem('radar_active') === 'false') return;
    localStorage.setItem('last_token', t);
    
    if(ws) { ws.onclose = null; ws.close(); }
    ws = new WebSocket(`wss://chat.anonim.chat/socket.io/?token=${t}&EIO=3&transport=websocket`);
    
    ws.onopen = () => {
        setInterval(() => { if(ws.readyState===1) ws.send('2'); }, 10000);
    };

    ws.onmessage = (e) => {
        if(e.data.startsWith('42')) {
            try {
                const j = JSON.parse(e.data.substring(e.data.indexOf('[')));
                const p = j[1];
                const d = p.d || p;
                const img = d.media?.media_url || d.message?.media?.media_url;
                const user = d.username || (d.message && d.message.username);
                const mid = d.msg_id || d.message?.msg_id || d.id;

                if(img && !fingerprints.has(img)) {
                    fingerprints.add(img);
                    renderImage(img, user, mid);
                    saveImageToStorage(img, user, mid); // BURASI: GELDƒ∞ƒûƒ∞ AN KAYDEDER
                    sysLog(`üì∏ Yeni: @${user}`, "var(--gold)");
                }
            } catch(err) {}
        }
    };
}

// EKRANA RESƒ∞M BASMA FONKSƒ∞YONU
function renderImage(src, user, id) {
    const grid = document.getElementById('gallery-grid');
    const div = document.createElement('div');
    div.className = 'gal-item-wrapper';
    div.innerHTML = `
        <img src="${src}" class="gal-item" onclick="sendSeen('${user}','${id}')" onerror="this.src='https://placehold.co/100x100?text=Silinmi≈ü'">
        <div class="user-tag">@${user}</div>
    `;
    grid.prepend(div);
}

function sendSeen(u, i) {
    if(!ws || ws.readyState !== 1) { 
        alert("Onay g√∂ndermek i√ßin dinleme aktif olmalƒ±!"); 
        return; 
    }
    ws.send(`420${JSON.stringify(["messageDataToUser", {"username": u, "type": "oneTimeMediaSeen", "msg_id": i}, null])}`);
    sysLog(`‚úîÔ∏è @${u} ki≈üisine onay iletildi.`, "var(--green)");
}

function generateShareLink() {
    const t = document.getElementById('token').value.trim();
    if(!t) return alert("√ñnce token girin!");
    const shareUrl = `${window.location.href.split('?')[0]}?token=${t}&start=true`;
    navigator.clipboard.writeText(shareUrl);
    sysLog("üîó Link kopyalandƒ±! Mobilde a√ßarsan otomatik ba≈ülar.");
}

function clearGallery() {
    if(confirm("T√ºm ar≈üiv silinecek. Emin misin?")) {
        localStorage.removeItem('radar_gallery_v55');
        fingerprints.clear();
        document.getElementById('gallery-grid').innerHTML = '';
        sysLog("üßπ Ar≈üiv temizlendi.", "var(--red)");
    }
}
</script>
</body>
</html>