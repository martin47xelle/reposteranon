<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radar v46 - Scroll Fix</title>
    <style>
        :root { --bg: #0b0e11; --card: #1e2329; --gold: #f0b90b; --green: #2ebd85; --blue: #3498db; --red: #f6465d; }
        
        /* Sayfa artƒ±k a≈üaƒüƒ± doƒüru doƒüal bir ≈üekilde uzar */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg); 
            color: #e9eaeb; 
            margin: 0; 
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center; 
            min-height: 100vh;
            overflow-y: auto; /* A≈üaƒüƒ± kaydƒ±rmayƒ± aktif eder */
        }

        .main-wrapper {
            width: 100%;
            max-width: 500px; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 30px; /* En altta bo≈üluk bƒ±rakƒ±r */
        }

        .box { 
            background: var(--card); 
            border-radius: 12px; 
            border: 1px solid #333; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header { 
            background: #2b3139; 
            padding: 12px; 
            font-weight: bold; 
            color: var(--gold); 
            border-bottom: 1px solid #444; 
            font-size: 13px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* Sabit y√ºkseklik yerine 'min-height' ve 'max-height' kullanarak esneklik saƒüladƒ±k */
        #gallery { 
            min-height: 120px;
            max-height: 250px; 
            overflow-y: auto; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 5px; 
            padding: 10px; 
            background: #000;
        }

        #sys-log { 
            height: 100px; 
            overflow-y: auto; 
            padding: 10px; 
            font-size: 11px; 
            color: #848e9c; 
            background: #161a1e; 
            border-top: 1px solid #333; 
        }

        #chat-flow { 
            min-height: 300px;
            max-height: 500px; /* √áok uzarsa kendi i√ßinde scroll olur, yoksa sayfayƒ± uzatƒ±r */
            overflow-y: auto; 
            padding: 15px; 
            background: #000; 
            font-family: 'Consolas', monospace; 
        }

        .msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; font-size: 13px; border-left: 4px solid transparent; }
        .msg.in { color: var(--gold); border-left-color: var(--gold); background: rgba(240, 185, 11, 0.07); }
        .msg.out { color: var(--green); border-left-color: var(--green); background: #121212; }
        .msg img { max-width: 100%; border-radius: 6px; margin-top: 8px; border: 1px solid #333; }

        .input-panel { padding: 12px; background: var(--card); border-top: 1px solid #333; }
        input, textarea { 
            width: 100%; 
            background: #121212; 
            border: 1px solid #444; 
            color: #fff; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 8px; 
            box-sizing: border-box; 
            font-size: 14px; 
        }

        button { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-full { width: 100%; margin-bottom: 8px; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-clear { background: var(--red); color: white; padding: 6px 12px; font-size: 11px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="box">
        <div class="header">
            <span>üì° Sƒ∞STEM VE GALERƒ∞</span>
            <button class="btn-clear" onclick="clearSystem()">TEMƒ∞ZLE</button>
        </div>
        <div id="gallery"></div>
        <div id="sys-log"></div>
        <div class="input-panel">
            <input type="text" id="token" placeholder="JWT Token...">
            <button class="btn-full btn-gold" onclick="connect()">BAƒûLAN</button>
        </div>
    </div>

    <div class="box">
        <div class="header">
            <span>üí¨ SOHBET</span>
            <button class="btn-clear" onclick="clearChat()">TEMƒ∞ZLE</button>
        </div>
        <div id="chat-flow"></div>
        <div class="input-panel">
            <input type="text" id="target" placeholder="Hedef Nick">
            <input type="text" id="photoUrl" placeholder="Foto Link">
            <button class="btn-full btn-blue" onclick="sendMedia()">üñºÔ∏è FOTO G√ñNDER</button>
            <textarea id="msg" rows="2" placeholder="Mesaj..."></textarea>
            <button class="btn-full btn-green" onclick="sendText()">G√ñNDER</button>
        </div>
    </div>
</div>

<script>
let ws;

function findVal(obj, key) {
    if (obj && obj.hasOwnProperty(key)) return obj[key];
    for (let i in obj) {
        if (typeof obj[i] === 'object' && obj[i] !== null) {
            let res = findVal(obj[i], key);
            if (res !== undefined) return res;
        }
    }
    return undefined;
}

function sysLog(m, c="#848e9c") { 
    const l = document.getElementById('sys-log'); 
    l.innerHTML += `<div style="color:${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`; 
    l.scrollTop = l.scrollHeight; 
}

function connect() {
    const t = document.getElementById('token').value.trim();
    if(!t) return;
    localStorage.setItem('last_token', t);
    if(ws) ws.close();
    ws = new WebSocket(`wss://chat.anonim.chat/socket.io/?token=${t}&EIO=3&transport=websocket`);
    ws.onopen = () => { sysLog("‚úÖ Baƒülantƒ± aktif.", "#2ebd85"); setInterval(() => { if(ws.readyState===1) ws.send('2'); }, 25000); };
    ws.onmessage = (e) => {
        if(e.data.startsWith('42')) {
            try {
                const j = JSON.parse(e.data.substring(e.data.indexOf('[')));
                const payload = j[1];
                if(payload.t === "messageData") {
                    const u = findVal(payload, "username");
                    const type = findVal(payload, "type");
                    if(type === "seen") updateStatus(u, "‚úì‚úì G√∂r√ºld√º", "var(--blue)");
                    if(type === "oneTimeMediaSeen") updateStatus(u, "üî• Foto A√ßƒ±ldƒ±", "#e67e22");
                    return;
                }
                const d = payload.d || payload;
                const u = findVal(d, "username");
                const txt = findVal(d, "message")?.message || findVal(d, "message");
                const img = findVal(d, "media_url") || findVal(d, "media")?.media_url;
                const m_id = findVal(d, "msg_id") || findVal(d, "message_id") || findVal(d, "id");
                if(u && (txt || img)) {
                    if(typeof txt === 'string') addChat(u, txt, 'in');
                    if(img) {
                        addGallery(img, u, m_id);
                        addChat(u, `<img src="${img}" onclick="sendMediaSeen('${u}', '${m_id}')">`, 'in');
                    }
                }
            } catch(err) {}
        }
    };
}

function addGallery(src, u, id) {
    const gal = document.getElementById('gallery');
    const img = document.createElement('img');
    img.src = src; img.style.width = "100%"; img.style.borderRadius = "4px";
    img.onclick = () => sendMediaSeen(u, id);
    gal.prepend(img);
}

function sendMediaSeen(username, msg_id) {
    if(!ws || ws.readyState !== 1 || !msg_id) return;
    const seenPayload = ["messageDataToUser", { "username": username, "type": "oneTimeMediaSeen", "msg_id": msg_id }, null];
    ws.send(`420${JSON.stringify(seenPayload)}`);
}

function updateStatus(username, label, color) {
    const indicators = document.querySelectorAll(`.msg.out[data-target="${username}"] .seen-status`);
    indicators.forEach(span => { span.innerHTML = `<span style="color:${color}; font-size:10px;">${label}</span>`; });
}

function sendMedia() {
    const target = document.getElementById('target').value.trim();
    const url = document.getElementById('photoUrl').value.trim();
    if(!ws || !target || !url) return;
    // Orijinal paket referans dosyadan alƒ±ndƒ±
    const mediaPayload = ["messageToUser", { "username": target, "message_id": Math.floor(Date.now() / 1000), "media": { "media_url": url, "media_mime_type": "image/jpeg", "media_ac_type": 8, "media_size": 7133, "media_duration": 0, "media_hash": "adf7e293599134777339fdc40ddfa818", "media_origin": 1 }, "anonymous_reveal": null }];
    ws.send(`420${JSON.stringify(mediaPayload)}`);
    addChat(target, `üñºÔ∏è Foto G√∂nderildi <br><img src="${url}">`, 'out');
}

function sendText() {
    const target = document.getElementById('target').value.trim();
    const content = document.getElementById('msg').value.trim();
    if(!ws || !target || !content) return;
    const textPayload = ["messageToUser", { "username": target, "message_id": Math.floor(Date.now() / 1000), "message": content }];
    ws.send(`420${JSON.stringify(textPayload)}`);
    addChat(target, content, 'out');
}

function addChat(u, t, type) {
    const flow = document.getElementById('chat-flow');
    const d = document.createElement('div');
    d.className = `msg ${type}`;
    if(type === 'out') d.setAttribute('data-target', u);
    d.innerHTML = `<b>${type==='in'?u:'BEN'}:</b> ${t} <span class="seen-status"></span>`;
    flow.appendChild(d);
    flow.scrollTop = flow.scrollHeight;
}

function clearChat() { document.getElementById('chat-flow').innerHTML = ''; }
function clearSystem() { document.getElementById('gallery').innerHTML = ''; document.getElementById('sys-log').innerHTML = ''; }

document.getElementById('token').value = localStorage.getItem('last_token') || "";
</script>
</body>
</html>